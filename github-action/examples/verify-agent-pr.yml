# Example: Verify agent-generated code in pull requests
#
# This workflow runs VRF verification on any code generated by AI agents
# before allowing the PR to merge. Works with Copilot, Cursor, Codex, etc.
#
# Prerequisites:
#   1. A VRF verify server running (self-hosted or public endpoint)
#   2. This action in your repo or referenced from clawbizarre/vrf-action

name: Verify Agent Output
on:
  pull_request:
    paths:
      - 'src/**'
      - 'lib/**'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Option A: Self-hosted verify server (docker sidecar)
      - name: Start VRF verify server
        run: |
          docker run -d --name vrf-server -p 8880:8880 \
            ghcr.io/clawbizarre/verify-server:latest
          # Wait for server to be ready
          for i in $(seq 1 10); do
            curl -sf http://localhost:8880/health && break
            sleep 1
          done

      # Verify a specific function from the PR
      - name: Verify sort implementation
        id: verify-sort
        uses: ./github-action  # or clawbizarre/vrf-action@v1
        with:
          code: |
            def sort_list(items):
                if len(items) <= 1:
                    return items
                pivot = items[len(items) // 2]
                left = [x for x in items if x < pivot]
                middle = [x for x in items if x == pivot]
                right = [x for x in items if x > pivot]
                return sort_list(left) + middle + sort_list(right)
          test_suite: |
            [
              {"input": "sort_list([3,1,2])", "expected": "[1, 2, 3]"},
              {"input": "sort_list([])", "expected": "[]"},
              {"input": "sort_list([1])", "expected": "[1]"},
              {"input": "sort_list([5,5,3,3,1])", "expected": "[1, 3, 3, 5, 5]"},
              {"input": "sort_list([-1,0,1])", "expected": "[-1, 0, 1]"}
            ]
          language: python
          fail_on_reject: 'true'

      # Use receipt in downstream steps
      - name: Archive VRF receipt
        if: always()
        run: |
          echo '${{ steps.verify-sort.outputs.receipt }}' > vrf-receipt.json
          echo "Verdict: ${{ steps.verify-sort.outputs.verdict }}"
          echo "Tests: ${{ steps.verify-sort.outputs.tests_passed }}/${{ steps.verify-sort.outputs.tests_total }}"

      - name: Upload receipt artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vrf-receipt
          path: vrf-receipt.json
